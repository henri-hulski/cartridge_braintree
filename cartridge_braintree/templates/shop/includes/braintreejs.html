{% load i18n mezzanine_tags checkout_tags static %}
{% comment %}
Set up braintree.js to create a payment_method_nonce for payment processing.
Based on cartridge-pinpayments.

See also https://developer.paypal.com/braintree/docs/guides/client-sdk/setup/javascript/v2.

NOTE: This requires the following modifications to the 'checkout.html' template:

id='checkout-form' on the form element
name='next' on the 'Next' submit button.

If you override the 'checkout.html' template, make sure your template also
contains these changes.

{% endcomment %}

{% compress js %}
<script src="{% static "cartridge_braintree/js/jquery.payment.js" %}"></script>
<script type="text/javascript">
    $('#id_card_number').payment('formatCardNumber');
    $('#id_card_ccv').payment('formatCardCVC');
</script>
<script src="{% static "cartridge_braintree/js/braintree-2.32.1/braintree-modal.js" %}"></script>
<script type="text/javascript">
    var client,
        form = $("#checkout-form"),
        nextButton = form.find(":submit[name='next']"),
        backButton = form.find(":submit[name='back']"),
        nonceField = $("#id_payment_method_nonce"),
        errorsField = $("#id_braintree_errors");

    function clearErrors() {
        // Clear previous errors
        errorsField.val("");
        $("#no_braintree").addClass('hidden');
    }

    $(function() {
        backButton.click(function() {
            // Clicking the 'back' button is always OK.
            clearErrors();
            // continue with form submission
            return;
        });

        try {
            client = new braintree.api.Client({
                clientToken: "{{ client_token }}"
            });
        }
        catch (err) {
            // The braintree.js script was not loaded successfully, so we want to
            // display an error to the user.
            console.error("{% trans "Braintree API could not be created." %}");
            $("#no_braintree").removeClass('hidden');
        }

        nextButton.click(function(e) {
            // 'Next' button was clicked.
            e.preventDefault();

            clearErrors();

            // Disable the submit button to prevent multiple clicks
            nextButton.prop('disabled', true);

            // Validate card payment form
            var cardNumber = $('#id_card_number').val(),
                expiryMonth = $('#id_card_expiry_month').val(),
                expiryYear = $('#id_card_expiry_year').val(),
                cardCCV = $('#id_card_ccv').val(),
                allowedCartTypes = {{ settings.SHOP_CARD_TYPES|lower|safe }},
                cardType = '',
                errors = {};
            if (!cardNumber.trim()) {
                errors.cardNumber = 'blank';
            } else if ($.payment.validateCardNumber(cardNumber) === true) {
                cardType = $.payment.cardType(cardNumber);
                if (!allowedCartTypes.includes(cardType)) {
                    errors.cardNumber = 'invalid_type';
                }
            } else {
                errors.cardNumber = 'invalid';
            }
            if ($.payment.validateCardExpiry(expiryMonth, expiryYear) !== true) {
                errors.cardExpiry = 'invalid';
            }
            if (!cardCCV.trim()) {
                errors.cardCCV = 'blank';
            } else if (cardType && $.payment.validateCardCVC(cardCCV, cardType) !== true) {
                errors.cardCCV = 'invalid';
            }

            if ($.isEmptyObject(errors)) {
                // Create nonce for the card
                client.tokenizeCard({
                    number:  cardNumber,
                    expirationMonth:  expiryMonth,
                    expirationYear: expiryYear,
                    cvv: cardCCV,
                }, function (err, nonce) {
                    // Set the nonce and errors in the form
                    if (err) {
                        errors.tokenizeCard = 'failed';
                        errorsField.val(JSON.stringify(errors));
                        console.error('Braintree request could not be processed.');
                        console.error(err);
                    } else {
                        nonceField.val(nonce);
                    }

                    // Resubmit the form to the server
                    // The card_number and card_ccv will not be submitted to the server,
                    // as the form inputs have no 'name' attribute.
                    // Instead the nonce and error messages are submitted to the server.
                    form[0].submit();
                });
            } else {
                errorsField.val(JSON.stringify(errors));
                // Re-enable the next button
                nextButton.prop('disabled', false);
                form[0].submit();
            }
        });
    });
</script>

{% if settings.BRAINTREE_PAYPAL_ACTIVATE %}
{% get_order_total as order_total %}
<script type="text/javascript">
    $(function() {
        var cardButton = $("#card").find("button:visible")[0],
            paypalButton = $("#paypal").find("button:visible")[0],
            card = $("#card-details"),
            paymentMethod = $("#id_payment_method"),
            djangoReturnedErrors = form.find(".form-errors").length;

        // Disable the next button and hide the card details fieldset.
        nextButton.prop('disabled', true);
        card.addClass('hidden');

        function activateCardPayment() {
            // Show card details form, set payment method to card
            // and re-enable the next button.
            card.removeClass('hidden');
            paymentMethod.val('card');
            nextButton.prop('disabled', false);
        }

        // Show Card payment details when Django returned errors
        if (djangoReturnedErrors) {
            activateCardPayment();
        }

        cardButton.addEventListener('click', function () {
            activateCardPayment();
        });

        var checkout;

        braintree.setup("{{ client_token }}", "custom", {
            enableCORS: true,
            onReady: function (integration) {
                checkout = integration;
            },
            onPaymentMethodReceived: function (payload) {
                // Set the nonce in the form
                nonceField.val(payload.nonce);
                form[0].submit();
            },
            paypal: {
                singleUse: true,
                amount: {{ order_total }}.toFixed(2),
                currency: '{{ settings.BRAINTREE_PAYPAL_CURRENCY }}',
                locale: '{{ LANGUAGE_CODE }}',
                headless: true,
            },
            onError: function(paypalErr) {
                console.error(paypalErr.type + ' error when creating PayPal:', paypalErr);
            }
        });

        clearErrors()

        paypalButton.removeAttribute('disabled');

        paypalButton.addEventListener('click', function(event) {
            // 'PayPal' button was clicked.

            // Disable the button so that we don't attempt to open multiple popups.
            paypalButton.setAttribute('disabled', true);
            // Hide Card details form, set payment method to paypal
            // and disable the next button and the paypal button.
            card.addClass('hidden');
            paymentMethod.val('paypal');
            nextButton.attr({disabled: true});
            paypalButton.setAttribute('disabled', true);

            // Invoke the paypal.initAuthFlow method
            // returned from the onReady callback.
            checkout.paypal.initAuthFlow();
        });
    });
</script>
{% endif %}
{% endcompress %}
